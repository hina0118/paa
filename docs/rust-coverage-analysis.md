# Rust カバレッジ 65% 未達の分析

**作成日**: 2026-02-05  
**更新**: 2026-02-05 — BatchRunner モックテスト追加により **66.43%** に改善（閾値 65% 達成）

---

## 1. 全体サマリー

| 指標         | 値     | 閾値 | 状態    |
| ------------ | ------ | ---- | ------- |
| 行カバレッジ | 64.97% | 65%  | ❌ 未達 |
| リージョン   | 67.40% | -    | -       |
| 関数         | 54.34% | -    | -       |

---

## 2. 低カバレッジの主因（影響度順）

### 2.1 lib.rs — **18.06%**（最大の要因）

| 項目         | 値                                              |
| ------------ | ----------------------------------------------- |
| 行数         | 1,628 行（未カバー 1,334 行）                   |
| 関数         | 244 中 200 未実行                               |
| 全体への影響 | 約 20% のコード量を占め、カバレッジが極端に低い |

**未カバー領域の内容**:

- Tauri コマンドハンドラ（`start_sync`, `start_parse`, `start_email_parse`, `save_image` など）
- UI イベント処理（`on_tray_icon_event`, `on_window_event`）
- DB 初期化・マイグレーション
- アプリ起動時のセットアップ（`setup`）

**カバーが難しい理由**:

- Tauri の `AppHandle` / `State` に強く依存
- 非同期ランタイム、イベントループが必要
- ウィンドウ・トレイなどの UI コンポーネントに依存

**対応案**:

1. **統合テスト**: `command_tests.rs` のように DB 付きでコマンドを呼び出すテストを増やす
2. **モック・トレイト**: `AppHandle` をトレイトで抽象化し、テスト用実装を差し替える
3. **部分テスト**: コマンド内の純粋なロジックを別関数に切り出し、単体テストでカバーする

---

### 2.2 gemini/config.rs — **0%**

| 項目 | 値            |
| ---- | ------------- |
| 行数 | 46 行         |
| 関数 | 9 中 9 未実行 |

**内容**: Gemini API の設定（keyring 依存の可能性）

**対応案**: keyring をモックするテスト、または `.llvm-cov.toml` の `exclude-files` に追加（gmail/config, google_search/config と同様）

---

### 2.3 gmail/config.rs, google_search/config.rs — **0%**

| ファイル                | 行数 | 備考                             |
| ----------------------- | ---- | -------------------------------- |
| gmail/config.rs         | 96   | `.llvm-cov.toml` で **除外済み** |
| google_search/config.rs | 49   | `.llvm-cov.toml` で **除外済み** |

CI では `exclude-files` によりカバレッジ計算から除外されている。

---

### 2.4 batch_runner.rs — **55.99%**

| 項目 | 値                        |
| ---- | ------------------------- |
| 行数 | 359 行（未カバー 158 行） |
| 関数 | 22 中 8 未実行            |

**未カバー領域**: `run` の実行フロー、タイムアウト・キャンセル処理、エラーハンドリング

**対応案**: `BatchRunner::run` をモック可能なトレイトで抽象化し、タスクのモックで実行パスをテストする

---

### 2.5 gemini/client.rs — **53.56%**

| 項目 | 値                        |
| ---- | ------------------------- |
| 行数 | 295 行（未カバー 137 行） |
| 関数 | 29 中 16 未実行           |

**未カバー領域**: API 呼び出し、リトライ、エラーハンドリング

**対応案**: `wiremock` 等で HTTP をモックし、API 呼び出し経路のテストを追加

---

### 2.6 その他（カバレッジ 70% 以上）

| ファイル      | 行カバレッジ | 備考                             |
| ------------- | ------------ | -------------------------------- |
| config.rs     | 86.44%       | paa_config.json 管理、テストあり |
| repository.rs | 90.04%       | 良好                             |
| logic/\*      | 98% 前後     | 良好                             |
| parsers/\*    | 70–98%       | 良好                             |

---

## 3. CI との差異

`.llvm-cov.toml` の `exclude-files` により、CI では以下を除外:

```
src/gmail/
src/google_search/
```

ローカルで gmail/google_search を含めた場合と、CI で除外した場合で、全体カバレッジの算出結果が異なる可能性がある。  
CI の `coverage.json` の `totals` が、この除外を反映した値かどうかを確認する必要がある。

---

## 4. 推奨対応順序

| 優先度 | 対応内容                                | 期待効果             |
| ------ | --------------------------------------- | -------------------- |
| **P0** | lib.rs の Tauri コマンド統合テスト追加  | 65% 到達に直結       |
| **P1** | gemini/config.rs の除外またはテスト追加 | 0% の影響を削減      |
| **P2** | batch_runner.rs の `run` 経路のテスト   | 56% → 70% 程度を目標 |
| **P3** | gemini/client.rs の API モックテスト    | 54% → 70% 程度を目標 |

---

## 5. 次のアクション

1. **CI の coverage.json を確認**: 除外設定適用後の `totals.lines.percent` を確認する
2. **lib.rs の統合テスト拡充**: `command_tests.rs` を参考に、未カバーのコマンドを追加する
3. **gemini/config.rs**: keyring 依存を確認し、除外またはモックテストを検討する
