# カバレッジ改善計画

最終更新: 2026-01-28

## 現在の状況

- **現在のカバレッジ**: 72.06%（ローカル）
- **CIでのカバレッジ**: 65%（一部テストをスキップ）
- **目標カバレッジ**: 65%（CI環境での実測値に合わせて設定）
- **最終目標カバレッジ**: 85%（将来的な目標）

## カバレッジが低いファイル

| ファイル         | 現在のカバレッジ | 目標 | 状態            |
| ---------------- | ---------------- | ---- | --------------- |
| `lib.rs`         | 15.38%           | 85%  | ❌ 大幅改善必要 |
| `parsers/mod.rs` | 61.78%           | 85%  | ⚠️ 改善必要     |
| `gmail.rs`       | 71.12%           | 85%  | ⚠️ 改善必要     |

## 追加テスト候補

### 1. `lib.rs` (15.38% → 85%)

#### 優先度: 高

**Tauriコマンドハンドラのテスト**

現在、`lib.rs`には以下のTauriコマンドがありますが、テストが不足しています：

1. **`start_sync`** - Gmail同期開始
   - 正常系: 同期が正常に開始される
   - エラー系: 同期開始時のエラーハンドリング
   - イベント発行: `sync-progress`イベントが発行される

2. **`cancel_sync`** - 同期キャンセル
   - 正常系: 同期がキャンセルされる
   - 状態確認: `SyncState`が正しく更新される

3. **`get_sync_status`** - 同期状態取得
   - 正常系: 状態が正しく取得される
   - エラー系: DBエラーのハンドリング

4. **`reset_sync_status`** - 同期状態リセット
   - 正常系: 状態がリセットされる
   - エラー系: DBエラーのハンドリング

5. **`reset_sync_date`** - 同期日付リセット
   - 正常系: 日付がリセットされる

6. **`update_batch_size`** - バッチサイズ更新
   - 正常系: バッチサイズが更新される
   - バリデーション: 無効な値のハンドリング

7. **`update_max_iterations`** - 最大反復回数更新
   - 正常系: 最大反復回数が更新される
   - バリデーション: 無効な値のハンドリング

8. **`get_window_settings`** - ウィンドウ設定取得
   - 正常系: 設定が取得される
   - デフォルト値: 設定がない場合のデフォルト値

9. **`save_window_settings`** - ウィンドウ設定保存
   - 正常系: 設定が保存される
   - 更新: 既存設定の更新

10. **`fetch_gmail_emails`** - Gmailメール取得
    - 正常系: メールが取得される
    - エラー系: Gmail APIエラー

11. **`get_email_stats`** - メール統計取得
    - 正常系: 統計が取得される
    - エラー系: DBエラー

12. **`get_logs`** - ログ取得
    - 正常系: ログが取得される
    - フィルタリング: レベルフィルタリング
    - リミット: 件数制限

13. **`get_all_shop_settings`** - 店舗設定一覧取得
    - 正常系: 設定一覧が取得される

14. **`create_shop_setting`** - 店舗設定作成
    - 正常系: 設定が作成される
    - バリデーション: 無効な値のハンドリング

15. **`update_shop_setting`** - 店舗設定更新
    - 正常系: 設定が更新される
    - 部分更新: 一部フィールドのみの更新

16. **`delete_shop_setting`** - 店舗設定削除
    - 正常系: 設定が削除される
    - エラー系: 存在しないIDの削除

17. **`parse_email`** - メールパース
    - 正常系: メールがパースされる
    - エラー系: 無効なパーサータイプ
    - エラー系: パースエラー

18. **`parse_and_save_email`** - メールパース＆保存
    - 正常系: メールがパースされ保存される
    - エラー系: パースエラー
    - エラー系: 保存エラー

19. **`start_batch_parse`** - バッチパース開始
    - 正常系: バッチパースが開始される
    - エラー系: 既に実行中の場合
    - イベント発行: `parse-progress`イベント

20. **`cancel_parse`** - パースキャンセル
    - 正常系: パースがキャンセルされる

21. **`get_parse_status`** - パース状態取得
    - 正常系: 状態が取得される

22. **`update_parse_batch_size`** - パースバッチサイズ更新
    - 正常系: バッチサイズが更新される

**ログ機能のテスト**

23. **`init_log_buffer`** - ログバッファ初期化
    - ✅ 既存テストあり

24. **`add_log_entry`** - ログエントリ追加
    - ✅ 既存テストあり

25. **`get_logs`** - ログ取得
    - ✅ 既存テストあり（追加テスト可能）

**実装方法**

- Tauriのテストフレームワークを使用
- モックデータベースを使用
- イベント発行の検証

### 2. `parsers/mod.rs` (61.78% → 85%)

#### 優先度: 高

**`batch_parse_emails`関数のテスト**

現在、`batch_parse_emails`関数のテストが不足しています：

1. **正常系テスト**
   - メールが正常にパースされる
   - 複数のメールをバッチで処理
   - パース済みメールのスキップ

2. **エラーケーステスト**
   - 有効な店舗設定がない場合
   - パースエラーが発生した場合
   - データベースエラー

3. **キャンセル処理テスト**
   - パース中にキャンセルされる
   - キャンセル後の状態確認

4. **イベント発行テスト**
   - `parse-progress`イベントが正しく発行される
   - 進捗情報が正しく含まれる

5. **エッジケーステスト**
   - 空のメールリスト
   - 大量のメール処理
   - 複数のパーサー候補がある場合
   - 件名フィルターの動作

**`ParseState`のテスト**

6. **`ParseState::new`** - 状態初期化
   - ✅ 既存テストあり

7. **`ParseState::request_cancel`** - キャンセル要求
   - ✅ 既存テストあり

8. **`ParseState::is_cancelled`** - キャンセル状態確認
   - ✅ 既存テストあり

9. **`ParseState::start`** - パース開始
   - ✅ 既存テストあり（追加テスト可能）
   - 既に実行中の場合はエラー

10. **`ParseState::finish`** - パース終了
    - ✅ 既存テストあり

**`get_parser`関数のテスト**

11. **`get_parser`** - パーサー取得
    - ✅ 既存テストあり（追加テスト可能）
    - 無効なパーサータイプの場合

**実装方法**

- モックデータベースを使用
- モックAppHandleを使用
- パーサーのモック化

### 3. `gmail.rs` (71.12% → 85%)

#### 優先度: 中

**未カバー部分の特定が必要**

1. **`GmailClient::new`** - Gmailクライアント初期化
   - 認証処理のテスト（モック使用）

2. **`sync_gmail_incremental`** - 増分同期
   - エラーハンドリングのテスト
   - キャンセル処理のテスト
   - イベント発行のテスト

3. **エッジケース**
   - 空のメッセージリスト
   - 大量のメッセージ処理
   - タイムアウト処理

**実装方法**

- GmailClientのモック化
- エラーケースのシミュレーション

## 実装優先順位

### Phase 1: 高優先度（+8-10%）

1. `lib.rs`のTauriコマンドテスト（20件）
   - 見積もり: 4-6時間
   - 期待カバレッジ向上: +5-7%

2. `parsers/mod.rs`の`batch_parse_emails`テスト（5件）
   - 見積もり: 2-3時間
   - 期待カバレッジ向上: +3-5%

### Phase 2: 中優先度（+3-5%）

3. `gmail.rs`の未カバー部分テスト
   - 見積もり: 2-3時間
   - 期待カバレッジ向上: +2-3%

### Phase 3: 低優先度（+1-2%）

4. エッジケースとエラーハンドリングの追加テスト
   - 見積もり: 1-2時間
   - 期待カバレッジ向上: +1-2%

## 実装ガイドライン

### テスト構造

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use sqlx::sqlite::SqlitePool;
    use tauri::test::MockRuntime;

    #[tokio::test]
    async fn test_command_name() {
        // テスト実装
    }
}
```

### モックの使用

- データベース: `setup_test_db()`を使用
- Tauri AppHandle: `tauri::test::MockRuntime`を使用
- GmailClient: `mockall`を使用

### テストカバレッジ確認

```bash
cd src-tauri
cargo llvm-cov --all-features --workspace --text --summary-only
```

## 目標達成の見込み

- Phase 1完了後: 約80%
- Phase 2完了後: 約83%
- Phase 3完了後: 約85%以上

合計見積もり時間: 7-11時間
