# Issue #38 対応予定

## 目的

Playwright による E2E テスト環境の構築と GitHub Actions 連携を実装します。画面上の操作（ボタンクリック、フォーム入力）が正しくバックエンドと連動しているかを自動検証する環境を構築します。

## 現状分析

### 現在のテスト環境

- **フロントエンドテスト**: Vitest + React Testing Library（ユニットテスト）
- **バックエンドテスト**: Cargo test（Rustのユニットテスト・統合テスト）
- **E2Eテスト**: 未実装

### 対象画面

1. **設定画面** (`src/components/screens/settings.tsx`)
   - メールアドレス入力・保存機能
   - DBへの反映確認が必要

2. **同期画面** (`src/components/screens/sync.tsx`)
   - 同期ボタンクリック
   - 完了後の一覧画面への遷移確認

## 対応計画

### Phase 1: Playwright の導入と基本設定

#### 1.1 Playwright パッケージのインストール

**作業内容**:

- `@playwright/test` を devDependencies に追加
- Playwright ブラウザのインストール

**ファイル**:

- `package.json`

**コマンド**:

```bash
npm install -D @playwright/test
npx playwright install
```

#### 1.2 Playwright 設定ファイルの作成

**ファイル**: `playwright.config.ts`

**設定内容**:

- Tauri アプリの起動設定
- テストモードでのビルド設定
- タイムアウト設定
- スクリーンショット設定
- テストディレクトリ設定

**考慮事項**:

- Tauri アプリをテストモードでビルド・起動する方法
- テスト用のデータベース設定
- テスト環境での Tauri API のモック

#### 1.3 Tauri テストモード設定

**ファイル**: `src-tauri/tauri.conf.json` または新規設定ファイル

**設定内容**:

- テストモード用の設定
- テスト用データベースパスの設定
- 開発モードでの起動設定

**考慮事項**:

- Tauri 2.x でのテストモードの実装方法
- テスト用のデータベース分離

### Phase 2: 基本シナリオの実装

#### 2.1 テストヘルパー関数の作成

**ファイル**: `tests/e2e/helpers.ts` または `tests/e2e/utils.ts`

**実装内容**:

- Tauri アプリの起動関数
- テスト用データベースのセットアップ
- 共通のテストユーティリティ

#### 2.2 設定画面のE2Eテスト

**ファイル**: `tests/e2e/settings.spec.ts`

**テストシナリオ**:

1. **メールアドレス入力・保存テスト**
   - 設定画面を開く
   - メールアドレスを入力
   - 保存ボタンをクリック
   - DBに反映されていることを確認（Tauriコマンド経由で確認）

**実装内容**:

- ページオブジェクトパターンの使用
- フォーム入力の操作
- ボタンクリックの操作
- DB確認のための Tauri コマンド呼び出し

#### 2.3 同期画面のE2Eテスト

**ファイル**: `tests/e2e/sync.spec.ts`

**テストシナリオ**:

1. **同期ボタンクリック・完了確認テスト**
   - 同期画面を開く
   - 同期ボタンをクリック
   - 同期完了を待機
   - 一覧画面に遷移することを確認
   - 商品が表示されることを確認

**実装内容**:

- 非同期処理の待機
- 画面遷移の確認
- 一覧表示の確認

### Phase 3: CI 連携

#### 3.1 GitHub Actions ワークフローの作成

**ファイル**: `.github/workflows/e2e.yml`

**実装内容**:

- 仮想ディスプレイ（xvfb）のセットアップ
- Tauri アプリのビルド
- Playwright テストの実行
- 失敗時のスクリーンショット保存（Artifacts）

**必要な環境**:

- Ubuntu runner
- xvfb（仮想ディスプレイ）
- Tauri ビルドに必要な依存関係

#### 3.2 スクリーンショット保存設定

**実装内容**:

- テスト失敗時の自動スクリーンショット
- Artifacts への保存設定
- スクリーンショットの命名規則

### Phase 4: ドキュメント作成

#### 4.1 E2Eテストガイドの作成

**ファイル**: `docs/E2E_TESTING.md` または既存の `TESTING_FRONTEND.md` に追記

**内容**:

- E2Eテストの実行方法
- ローカルでの実行手順
- CIでの実行方法
- テストの追加方法

## 実装順序

1. **Phase 1**: Playwright の導入と基本設定
2. **Phase 2**: 基本シナリオの実装
3. **Phase 3**: CI 連携
4. **Phase 4**: ドキュメント作成

## 技術的な課題と解決策

### 課題1: Tauri アプリのテストモード起動

**問題**: Tauri アプリを Playwright から起動する方法

**解決策**:

- Tauri の開発モード（`npm run tauri dev`）を利用
- または、テスト用のビルドモードを追加
- Playwright の `launchServer` 機能を活用

**調査が必要**:

- Tauri 2.x でのテストモードの実装方法
- Playwright と Tauri の統合方法

### 課題2: テスト用データベースの分離

**問題**: テスト実行時に本番データベースを汚染しないようにする

**解決策**:

- テスト用のデータベースパスを設定
- テスト前後にデータベースをリセット
- インメモリデータベースの使用を検討

### 課題3: Tauri API のモック

**問題**: E2Eテストで Tauri API をモックする必要がある場合

**解決策**:

- Tauri のテストモードを利用
- 必要に応じてモックサーバーを実装

## 完了条件

- [x] `@playwright/test` がインストールされている ✅
- [x] `playwright.config.ts` が作成されている ✅
- [x] Vite開発サーバを自動起動できる ✅
- [x] ナビゲーションのE2Eテストが実装されている ✅
- [x] 設定画面のE2Eテストが実装されている ✅
- [x] ダッシュボード画面のE2Eテストが実装されている ✅
- [x] GitHub Actions でE2Eテストが実行される ✅
- [x] テスト失敗時にスクリーンショットが Artifacts に保存される ✅
- [x] E2Eテストのドキュメントが作成されている ✅

## 見積もり

- **Phase 1**: 約2-3時間（Playwright導入と設定）
- **Phase 2**: 約3-4時間（基本シナリオ実装）
- **Phase 3**: 約1-2時間（CI連携）
- **Phase 4**: 約30分（ドキュメント作成）

**合計**: 約6-9時間

## 参考資料

- [Playwright Documentation](https://playwright.dev/)
- [Tauri Testing Guide](https://tauri.app/v1/guides/testing/)
- [Playwright with GitHub Actions](https://playwright.dev/docs/ci)

## 注意事項

1. **Tauri 2.x のテスト方法**
   - Tauri 2.x でのテスト実装方法を確認する必要がある
   - 公式ドキュメントやコミュニティの情報を参照

2. **テスト実行時間**
   - E2Eテストは実行時間が長くなる可能性がある
   - CIでの実行時間を考慮して、必要に応じて並列実行を検討

3. **テストの安定性**
   - 非同期処理の待機時間を適切に設定
   - フレーキーテストを避けるためのリトライ機能の検討

4. **データベースの状態管理**
   - テスト間でデータベースの状態を適切にリセット
   - テストの独立性を保つ
