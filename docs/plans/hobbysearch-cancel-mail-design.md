# 注文キャンセルメール 設計・対応計画

## 1. 概要

ホビーサーチの注文キャンセル完了通知メールをパースし、既存注文の商品数量を減算・削除する機能を実装する。

## 2. サンプルメール分析

**ファイル**: `sample/hobbysearch_mail_cancel.txt`

### 2.1 メール構造

```
--------------------------------------------------------
　【ホビーサーチ】ご注文のキャンセルが完了致しました
--------------------------------------------------------

　山田 太郎　様
　...

　[キャンセル]
　注文番号 ： 99-9999-9999
　商品名 ： 【抽選販売】 30MS オプションパーツセット22(ターボコスチュームα)[カラーB] (プラモデル)
　キャンセル個数 ： 1

------------------------------------------------
ホビーサーチ
https://www.1999.co.jp/
E-mail： hs-support@1999.co.jp
------------------------------------------------
```

### 2.2 抽出対象データ

| 項目           | 形式           | 正規表現候補                       |
| -------------- | -------------- | ---------------------------------- |
| 注文番号       | `XX-XXXX-XXXX` | `注文番号\s*[：:]\s*(\d+-\d+-\d+)` |
| 商品名         | 1行全体        | `商品名\s*[：:]\s*(.+)`            |
| キャンセル個数 | 整数           | `キャンセル個数\s*[：:]\s*(\d+)`   |

### 2.3 送信元・件名

- **送信元**: `hs-support@1999.co.jp`（既存の change, send と同じ）
- **件名**: `【ホビーサーチ】ご注文のキャンセルが完了致しました`
- **件名フィルター**: `["キャンセル"]` または `["ご注文のキャンセル"]` でマッチ可能

## 3. 現行システムとの差異

### 3.1 既存パーサーとの比較

| パーサー               | 戻り値      | 処理                  | 備考                        |
| ---------------------- | ----------- | --------------------- | --------------------------- |
| hobbysearch_confirm    | `OrderInfo` | 新規注文作成          | [ご購入内容] セクション     |
| hobbysearch_change     | `OrderInfo` | 注文更新（商品追加）  | 組み替えメール              |
| hobbysearch_send       | `OrderInfo` | 配送情報追加          | [運送会社] 等               |
| **hobbysearch_cancel** | **別型**    | **商品数量減算/削除** | **[キャンセル] セクション** |

キャンセルメールは「注文を作成/更新する」のではなく「既存注文の商品を減らす」という**逆向きの操作**である。

### 3.2 パースフロー上の位置づけ

- バッチパースは `internal_date` 昇順でメールを処理
- キャンセルメールは confirm/change の**後**に来ることが想定される
- キャンセル時点で、該当注文は既に DB に存在している前提

## 4. 設計方針

### 4.1 アプローチ選択

| 案                        | 内容                                                                    | メリット                                    | デメリット                 |
| ------------------------- | ----------------------------------------------------------------------- | ------------------------------------------- | -------------------------- |
| A. 新トレイト             | `CancelEmailParser` を新設し、`CancelInfo` を返す                       | 責務分離が明確                              | バッチループの分岐が増える |
| B. EmailParser 拡張       | `OrderInfo` に `is_cancel: bool` や `CancelAction` を追加               | 既存フローに乗せやすい                      | OrderInfo が複雑化         |
| C. 専用パーサー＋専用処理 | `hobbysearch_cancel` パーサーが `CancelInfo` を返し、バッチ側で条件分岐 | 既存 `EmailParser` を汚さない、拡張しやすい | バッチロジックの分岐が必要 |

**推奨: 案 C** … キャンセルは「注文作成」とは別のドメイン操作のため、専用構造体と専用処理を設ける。

### 4.2 データ構造

```rust
/// キャンセルメールから抽出した情報
#[derive(Debug, Clone)]
pub struct CancelInfo {
    pub order_number: String,
    pub product_name: String,
    pub cancel_quantity: i64,
}
```

### 4.3 商品マッチング戦略

キャンセルメールの商品名とDBの `item_name` は完全一致しない可能性がある。

- **優先1**: `item_name` 完全一致
- **優先2**: `item_name` 包含（キャンセル側の商品名がDB側に含まれる、またはその逆）
- **優先3**: `item_name_normalized` による正規化後の部分一致

複数候補がある場合は、最初にマッチしたものを採用（または最も数量が近いもの）。

## 5. 実装計画

### フェーズ1: パーサー実装

| #   | タスク                                | ファイル                                         | 内容                                                                |
| --- | ------------------------------------- | ------------------------------------------------ | ------------------------------------------------------------------- |
| 1.1 | `CancelInfo` 定義                     | `parsers/mod.rs` または `parsers/cancel_info.rs` | 構造体とシリアライズ                                                |
| 1.2 | `hobbysearch_cancel` パーサー         | `parsers/hobbysearch_cancel.rs`                  | `[キャンセル]` セクションから正規表現で抽出                         |
| 1.3 | `get_parser` 方針の確認（変更なし）   | `parsers/mod.rs`                                 | `hobbysearch_cancel` は EmailParser に追加せずバッチ側で分岐する方針を明記 |
| 1.4 | `is_valid_parser_type` 拡張           | `logic/email_parser.rs`                          | `hobbysearch_cancel` を有効な型に追加                               |
| 1.5 | マイグレーション                      | `migrations/001_init.sql` または新規             | shop_settings にキャンセル用の設定を追加                            |

### フェーズ2: リポジトリ拡張

| #   | タスク                  | ファイル        | 内容                                           |
| --- | ----------------------- | --------------- | ---------------------------------------------- |
| 2.1 | `apply_cancel` メソッド | `repository.rs` | `OrderRepository` にキャンセル適用を追加       |
| 2.2 | 商品検索ロジック        | `repository.rs` | order_number + product_name で対象 item を検索 |

### フェーズ3: バッチパース統合

| #   | タスク               | ファイル                                 | 内容                                                                 |
| --- | -------------------- | ---------------------------------------- | -------------------------------------------------------------------- |
| 3.1 | パーサー種別判定     | `parsers/mod.rs` の `batch_parse_emails` | `hobbysearch_cancel` の場合は `parse` ではなく `parse_cancel` を呼ぶ |
| 3.2 | キャンセル適用フロー | 同上                                     | `CancelInfo` を `apply_cancel` に渡す                                |
| 3.3 | order_emails 紐付け  | 同上                                     | キャンセルメールと注文の関連を `order_emails` に保存                 |

### フェーズ4: テスト・検証

| #   | タスク     | 内容                                                |
| --- | ---------- | --------------------------------------------------- |
| 4.1 | 単体テスト | `hobbysearch_cancel` のパーステスト（サンプル利用） |
| 4.2 | 統合テスト | キャンセル適用後の items 数量・削除の確認           |
| 4.3 | E2E        | フロントの注文一覧でキャンセル後の表示確認          |

## 6. 詳細仕様

### 6.1 パーサー正規表現

```rust
// [キャンセル] セクション内
let order_number_re = Regex::new(r"注文番号\s*[：:]\s*(\d+-\d+-\d+)")?;
let product_name_re = Regex::new(r"商品名\s*[：:]\s*(.+)")?;
let cancel_qty_re = Regex::new(r"キャンセル個数\s*[：:]\s*(\d+)")?;
```

### 6.2 キャンセル適用ロジック（apply_cancel）

1. `order_number` + `shop_domain` で orders を検索
2. 該当 order の items から `product_name` でマッチするものを検索（完全一致 → 包含）
3. マッチした item の `quantity` を `cancel_quantity` 減算
4. `quantity <= 0` の場合は該当 item を DELETE
5. `quantity > 0` の場合は UPDATE
6. `order_emails` に (order_id, email_id) を挿入（重複チェック付き）

### 6.3 パース順序の保証

- キャンセルメールは confirm/change より**後**にくる想定
- `internal_date` 昇順でパースしているため、通常は問題なし
- **稀にキャンセルが先に来た場合**: 該当 order が存在しなければ、`apply_cancel` は `Err` を返し、該当メールは「未パース」のまま残る。次回バッチ run で再度パース対象となり、その時点で confirm/change が先に処理されていればキャンセル適用が成功する。設計上の意図として、キャンセルが先に来たケースはスキップし、次回 run で再試行されることを許容する。

### 6.4 shop_settings 追加

```sql
-- キャンセルメール用（送信元は hs-support@1999.co.jp）
INSERT OR IGNORE INTO shop_settings (shop_name, sender_address, parser_type, subject_filters, is_enabled)
VALUES ('ホビーサーチ', 'hs-support@1999.co.jp', 'hobbysearch_cancel', '["ご注文のキャンセル"]', 1);
```

（注: 既存の change/send も hs-support を使っているため、件名フィルターで識別する）

## 7. リスク・考慮事項

| 項目                 | リスク                                        | 対応                                               |
| -------------------- | --------------------------------------------- | -------------------------------------------------- |
| 商品名の不一致       | キャンセルメールとconfirmメールで表記が異なる | 正規化・部分一致で許容範囲を広げる                 |
| 複数候補             | 同一注文に類似商品が複数ある                  | 最初にマッチしたものを適用（または future で改善） |
| パース順序           | キャンセルが先に来る                          | 注文未存在時はスキップし、ログに記録               |
| batch_parse の clear | 毎回 order 系テーブルをクリア                 | 現状維持。キャンセルはパースループ内で反映される   |

## 8. 次のステップ

1. 本設計のレビュー・合意
2. フェーズ1 の実装開始（`hobbysearch_cancel` パーサー）
3. フェーズ2 の `apply_cancel` 実装
4. フェーズ3 のバッチ統合
5. フェーズ4 のテスト
